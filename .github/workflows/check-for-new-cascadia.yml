name: Create tag if there's a new Cascadia version

on:
  schedule:
    - cron: "0 13 * * *"

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
    - name: Fetch latest release of Cascadia Code
      uses: octokit/request-action@v2.x
      id: get_latest_release
      with:
        route: GET /repos/{owner}/{repo}/releases/latest
        owner: microsoft
        repo: cascadia-code
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Get the latest Cascadia tag
      run: |
        echo "CASCADIATAG=${{ fromJson(steps.get_latest_release.outputs.data).tag_name }}" >> $GITHUB_ENV
        echo "Latest Cascadia tag is ${{ env.CASCADIATAG }}"
    - name: Check if tag exists
      uses: mukunku/tag-exists-action@v1.0.0
      id: check_tag
      with: 
        tag: ${{ env.CASCADIATAG }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Create tag
      if: ${{ steps.check_tag.outputs.exists != 'true' }}
      uses: actions/github-script@v3
      with:
        github-token: ${{ github.token }}
        script: |
          const createdTag = await github.git.createTag({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag: "${{ env.CASCADIATAG }}",
            message: "Bump Cascadia version to ${{ env.CASCADIATAG }}",
            object: context.sha,
            type: "commit"
          })
          
          github.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: "refs/tags/${{ env.CASCADIATAG }}",
              sha: createdTag.data.sha
          })
